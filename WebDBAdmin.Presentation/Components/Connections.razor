@using WebDBAdmin.Application.Interfaces
@using WebDBAdmin.Domain.Entities
@using WebDBAdmin.Presentation.Components
@inject IConnectionService ConnectionService
@inject Radzen.DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject SessionStateService SessionState
@inject IConnectionFactory ConnectionFactory
@inject Microsoft.Extensions.Localization.IStringLocalizer<WebDBAdmin.Presentation.Resources.SharedResource> Loc

<RadzenStack>
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
        JustifyContent="JustifyContent.SpaceBetween">
        <RadzenText TextStyle="TextStyle.H5">@Loc["StoredConnections"]</RadzenText>
        <RadzenButton Icon="add" Text="@Loc["AddConnection"]" ButtonStyle="ButtonStyle.Primary"
            Click="@AddConnection" />
    </RadzenStack>

    <RadzenDataGrid Data="@connections" TItem="ConnectionInfo" AllowSorting="true" AllowFiltering="true">
        <Columns>
            <RadzenDataGridColumn TItem="ConnectionInfo" Property="Name" Title="@Loc["ConnectionName"]">
                <Template Context="data">
                    @(string.IsNullOrEmpty(data.Name) ? $"{data.Server} ({data.Database})" : data.Name)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="ConnectionInfo" Property="Engine" Title="@Loc["Engine"]" Width="120px" />
            <RadzenDataGridColumn TItem="ConnectionInfo" Property="Server" Title="@Loc["Server"]" />
            <RadzenDataGridColumn TItem="ConnectionInfo" Property="Database" Title="@Loc["Database"]" />
            <RadzenDataGridColumn TItem="ConnectionInfo" Property="Username" Title="@Loc["User"]" />
            <RadzenDataGridColumn TItem="ConnectionInfo" Context="data" Filterable="false" Sortable="false"
                TextAlign="TextAlign.Center" Width="220px">
                <Template Context="data">
                    <RadzenButton Icon="login" ButtonStyle="ButtonStyle.Success" Variant="Radzen.Variant.Flat"
                        Size="ButtonSize.Medium" Click="@(() => OpenConnection(data))" Class="me-1"
                        Tooltip="@Loc["OpenConnection"]" />
                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Radzen.Variant.Flat"
                        Size="ButtonSize.Medium" Click="@(() => EditConnection(data))" Class="me-1" />
                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Radzen.Variant.Flat"
                        Size="ButtonSize.Medium" Click="@(() => DeleteConnection(data))" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</RadzenStack>

@code {
    [Parameter] public EventCallback<ConnectionInfo> OnConnectionOpen { get; set; }

    List<ConnectionInfo> connections = new List<ConnectionInfo>();

    protected override async Task OnInitializedAsync()
    {
        await LoadConnections();
    }

    async Task LoadConnections()
    {
        connections = await ConnectionService.GetAllAsync();
    }

    async Task AddConnection()
    {
        var result = await DialogService.OpenAsync<ConnectionDialog>(Loc["AddConnection"],
        new Dictionary<string, object> { { "SaveMode", true } },
        new Radzen.DialogOptions() { Width = "500px" });

        if (result is ConnectionInfo newConnection)
        {
            await ConnectionService.SaveAsync(newConnection);
            NotificationService.Notify(NotificationSeverity.Success, Loc["Saved"], Loc["ConnectionSaved"]);
            await LoadConnections();
        }
    }

    async Task EditConnection(ConnectionInfo connection)
    {
        var result = await DialogService.OpenAsync<ConnectionDialog>(Loc["EditConnection"],
        new Dictionary<string, object> { { "SaveMode", true }, { "Connection", connection } },
        new Radzen.DialogOptions() { Width = "500px" });

        if (result is ConnectionInfo updatedConnection)
        {
            await ConnectionService.SaveAsync(updatedConnection);
            NotificationService.Notify(NotificationSeverity.Success, Loc["Saved"], Loc["ConnectionUpdated"]);
            await LoadConnections();
        }
    }

    async Task DeleteConnection(ConnectionInfo connection)
    {
        var result = await DialogService.Confirm(Loc["AreYouSure"], Loc["DeleteConnection"], new Radzen.ConfirmOptions()
        {
            OkButtonText = Loc["Yes"],
            CancelButtonText = Loc["No"]
        });
        if (result == true)
        {
            await ConnectionService.DeleteAsync(connection.Id);
            NotificationService.Notify(NotificationSeverity.Success, Loc["Deleted"], Loc["ConnectionDeleted"]);
            await LoadConnections();
        }
    }

    async Task OpenConnection(ConnectionInfo connection)
    {
        try
        {
            // Verify connection
            using var dbConnection = ConnectionFactory.CreateConnection(connection);
            dbConnection.Open(); // IDbConnection.Open is void, usually sufficient to test.
                                 // If we want async open, we need to cast to DbConnection but not strictly required for this test.

            SessionState.SetConnection(connection);
            NotificationService.Notify(NotificationSeverity.Success, Loc["Connected"], $"{Loc["ConnectedTo"]} {connection.Server}");

            if (OnConnectionOpen.HasDelegate)
            {
                await OnConnectionOpen.InvokeAsync(connection);
            }
            else
            {
                NavigationManager.NavigateTo("/"); // Navigate to SqlWorkspace (Home)
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, Loc["ConnectionFailed"], ex.Message);
        }
    }
}